#!/bin/bash

# Cudo - CUDA Development Environment Manager
# Usage: cudo [command] [options]

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
# 如果 SCRIPT_DIR 指向的是主脚本所在目录，那么 Python 脚本应该在 scripts 子目录中
PYTHON_SCRIPT_DIR="$SCRIPT_DIR/scripts"
PROJECT_ROOT="$(pwd)"

# Default Config
DEFAULT_CUDA_VERSION="12.4.0"
DEFAULT_UBUNTU_VERSION="20.04"
DEFAULT_WITH_TOOLKIT="false"
DEFAULT_PYTHON_VERSION="3.10"
DEFAULT_IMAGE_NAME="cuda-project-$(basename "$PROJECT_ROOT" | tr '[:upper:]' '[:lower:]')"

CONFIG_DIR="$PROJECT_ROOT/.cudo"

CONFIG_FILE="$CONFIG_DIR/config"
DOCKERFILE="$CONFIG_DIR/Dockerfile"
DOCKER_COMPOSE_FILE="$CONFIG_DIR/docker-compose.yml"

# Global configuration directory (stores all project information)
GLOBAL_CONFIG_DIR="$HOME/.cudo-global"
mkdir -p $GLOBAL_CONFIG_DIR

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Log Function
log_info() { echo -e "${BLUE}ℹ️  $1${NC}"; }
log_success() { echo -e "${GREEN}✅  $1${NC}"; }
log_warning() { echo -e "${YELLOW}⚠️  $1${NC}"; }
log_error() { echo -e "${RED}❌  $1${NC}"; }


save_config() {
    cat > "$CONFIG_FILE" << EOF
CUDA_VERSION=$CUDA_VERSION
UBUNTU_VERSION=$UBUNTU_VERSION
WITH_TOOLKIT=$WITH_TOOLKIT
PYTHON_VERSION=$PYTHON_VERSION
IMAGE_NAME=$IMAGE_NAME
CUDA_VARIANT=$CUDA_VARIANT
EOF
    log_success "Configuration saved"
}

save_to_global() {
    local project_name=$(basename "$PROJECT_ROOT")
    local project_path_hash=$(echo -n "$PROJECT_ROOT" | md5sum | cut -d' ' -f1 | head -c 8)
    local unique_id="${project_name}-${project_path_hash}"
    local global_config_file="$GLOBAL_CONFIG_DIR/${unique_id}.conf"
    
    # 检查是否已存在相同路径的配置
    local existing_config=$(find "$GLOBAL_CONFIG_DIR" -name "*.conf" -exec grep -l "PROJECT_PATH=$PROJECT_ROOT$" {} \;)
    
    if [ -n "$existing_config" ]; then
        rm -f "$existing_config"
    fi
    
    cat > "$global_config_file" << EOF
PROJECT_NAME=$project_name
PROJECT_PATH=$PROJECT_ROOT
CUDA_VERSION=$CUDA_VERSION
UBUNTU_VERSION=$UBUNTU_VERSION
WITH_TOOLKIT=$WITH_TOOLKIT
PYTHON_VERSION=$PYTHON_VERSION
IMAGE_NAME=$IMAGE_NAME
CUDA_VARIANT=$CUDA_VARIANT
CREATED_TIME="$(date '+%Y-%m-%d %H:%M:%S')"
LAST_UPDATED="$(date '+%Y-%m-%d %H:%M:%S')"
UNIQUE_ID=$unique_id
STATUS=active
EOF
    log_success "Configuration saved to global storage: $unique_id"
}

remove_from_global() {
    local project_name=$(basename "$PROJECT_ROOT")
    local project_path_hash=$(echo -n "$PROJECT_ROOT" | md5sum | cut -d' ' -f1 | head -c 8)
    local unique_id="${project_name}-${project_path_hash}"
    local global_config_file="$GLOBAL_CONFIG_DIR/${unique_id}.conf"
    
    if [ -f "$global_config_file" ]; then
        rm -f "$global_config_file"
        log_success "Removed from global storage: $unique_id"
    fi
}

# 检查并更新全局配置状态
update_global_status() {
    # 遍历所有全局配置文件
    for config_file in "$GLOBAL_CONFIG_DIR"/*.conf; do
        if [ -f "$config_file" ]; then
            source "$config_file"
            
            # 检查项目路径是否还存在容器配置文件夹
            local config_dir="$PROJECT_PATH/.cuda-docker-config"
            if [ ! -d "$config_dir" ]; then
                # 标记为已删除或已移动
                sed -i "s|STATUS=.*|STATUS=deleted|" "$config_file"
                sed -i "s|LAST_UPDATED=.*|LAST_UPDATED=\"$(date '+%Y-%m-%d %H:%M:%S')\"|" "$config_file"
            else
                # 确保状态是 active
                sed -i "s|STATUS=.*|STATUS=active|" "$config_file"
                sed -i "s|LAST_UPDATED=.*|LAST_UPDATED=\"$(date '+%Y-%m-%d %H:%M:%S')\"|" "$config_file"
            fi
        fi
    done
}

# 清理旧的全局配置文件（基于项目名称的）
cleanup_old_global_configs() {
    local project_name=$(basename "$PROJECT_ROOT")
    local project_path_hash=$(echo -n "$PROJECT_ROOT" | md5sum | cut -d' ' -f1 | head -c 8)
    local current_unique_id="${project_name}-${project_path_hash}"
    
    # 查找所有相同项目名称的旧配置文件
    for old_config in "$GLOBAL_CONFIG_DIR/${project_name}.conf"*; do
        if [ -f "$old_config" ] && [[ "$old_config" != *"$current_unique_id.conf" ]]; then
            rm -f "$old_config"
            log_info "Cleaned up old global config: $(basename "$old_config")"
        fi
    done
}

# 加载配置
load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE"
        return 0
    else
        return 1
    fi
}

# 检查依赖
check_dependencies() {
    local missing=()
    
    if ! command -v docker &> /dev/null; then
        missing+=("docker")
    fi
    
    if ! command -v docker-compose &> /dev/null; then
        missing+=("docker-compose")
    fi
    
    if ! command -v envsubst &> /dev/null; then
        missing+=("envsubst (gettext)")
    fi
    
    if [ ${#missing[@]} -ne 0 ]; then
        log_error "Missing dependencies: ${missing[*]}"
        echo "Please install the following software:"
        for dep in "${missing[@]}"; do
            case $dep in
                "docker")
                    echo "  Docker: https://docs.docker.com/get-docker/"
                    ;;
                "docker-compose")
                    echo "  Docker Compose: https://docs.docker.com/compose/install/"
                    ;;
                "envsubst (gettext)")
                    echo "  envsubst:"
                    echo "    Ubuntu/Debian: sudo apt-get install gettext"
                    echo "    CentOS/RHEL: sudo yum install gettext"
                    ;;
            esac
        done
        exit 1
    fi
}

# 生成 Dockerfile
generate_dockerfile() {
    local cuda_version=$1
    local ubuntu_version=$2
    local cuda_variant=$3
    local python_version=$4
    
    # 获取当前用户信息
    local current_user=$(id -un)
    local current_uid=$(id -u)
    local current_gid=$(id -g)
    
    cat > "$DOCKERFILE" << EOF
FROM nvidia/cuda:${cuda_version}-${cuda_variant}-ubuntu${ubuntu_version}

ENV LANG=C.UTF-8 LC_ALL=C.UTF-8
ENV PATH /opt/conda/bin:\$PATH

# 安装基础工具
RUN apt-get update && apt-get install -y --no-install-recommends \\
    wget \\
    bzip2 \\
    ca-certificates \\
    libglib2.0-0 \\
    libxext6 \\
    libsm6 \\
    libxrender1 \\
    libgl1-mesa-glx \\
    git \\
    build-essential \\
    mercurial \\
    subversion \\
    tmux \\
    vim \\
    curl \\
    sudo \\
    && apt-get clean \\
    && rm -rf /var/lib/apt/lists/*

# 安装 Miniconda
RUN wget --quiet https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O ~/miniconda.sh && \\
    /bin/bash ~/miniconda.sh -b -p /opt/conda && \\
    rm ~/miniconda.sh && \\
    ln -s /opt/conda/etc/profile.d/conda.sh /etc/profile.d/conda.sh

# 设置conda环境
RUN conda config --set always_yes yes --set changeps1 no && \\
    conda clean -ya && \\
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main && \\
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r && \\
    conda install python=${python_version} && \\
    conda config --set always_yes false --set changeps1 yes

# 创建工作目录
WORKDIR /workspace

# 创建用户并设置权限（在安装完所有软件后切换用户）
RUN groupadd -g ${current_gid} ${current_user} && \\
    useradd -m -u ${current_uid} -g ${current_gid} -s /bin/bash ${current_user} && \\
    echo "${current_user} ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/${current_user} && \\
    chmod 0440 /etc/sudoers.d/${current_user} && \\
    chown -R ${current_user}:${current_user} /opt/conda && \\
    chown -R ${current_user}:${current_user} /workspace

# 切换用户
USER ${current_user}

# 为用户配置 conda
RUN echo ". /opt/conda/etc/profile.d/conda.sh" >> ~/.bashrc && \\
    echo "conda activate base" >> ~/.bashrc

CMD ["/bin/bash"]
EOF
    log_success "Dockerfile generated"
}

# 生成 docker-compose.yml
generate_docker_compose() {
    local image_name=$1
    
    # 从镜像名称生成服务名称（移除特殊字符）
    local service_name=$(echo "${image_name}" | sed 's/[^a-zA-Z0-9_-]//g')
    
    cat > "$DOCKER_COMPOSE_FILE" << EOF
version: '3.8'

services:
  ${service_name}:
    build:
      context: .
      dockerfile: Dockerfile
    image: ${image_name}
    network_mode: host
    container_name: ${image_name}-container
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
    volumes:
      - ..:/workspace
      - /tmp/.X11-unix:/tmp/.X11-unix
    working_dir: /workspace
    stdin_open: true
    tty: true
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
EOF
    log_success "docker-compose.yml generated"
    log_info "Service name: ${service_name}"
}

# 构建镜像
build_image() {
    log_info "Starting image build..."
    cd "$CONFIG_DIR"
    
    if docker_compose_cmd build; then
        log_success "Image build successful!"
        log_info "Image name: $IMAGE_NAME"
        log_info "Working directory: $PROJECT_ROOT"
    else
        log_error "Image build failed!"
        exit 1
    fi
}

# 获取容器资源使用信息
get_container_stats() {
    local container_name="$1-container"
    local stats_output
    
    if docker ps --format "table {{.Names}}" | grep -q "$container_name"; then
        # 获取 CPU 使用率
        local cpu_usage=$(docker stats --no-stream --format "{{.CPUPerc}}" "$container_name" 2>/dev/null | head -1 || echo "N/A")
        
        # 获取内存使用
        local mem_usage=$(docker stats --no-stream --format "{{.MemUsage}}" "$container_name" 2>/dev/null | head -1 || echo "N/A")
        
        # 获取内存限制
        local mem_limit=$(docker stats --no-stream --format "{{.MemPerc}}" "$container_name" 2>/dev/null | head -1 || echo "N/A")
        
        echo "$cpu_usage|$mem_usage|$mem_limit"
    else
        echo "N/A|N/A|N/A"
    fi
}

# 获取容器详细信息
get_container_info() {
    local container_name="$1-container"
    local info_output
    
    if docker ps -a --format "table {{.Names}}" | grep -q "$container_name"; then
        # 获取容器状态
        local status=$(docker ps -a --format "table {{.Names}}\t{{.Status}}" | grep "$container_name" | awk '{print $2}')
        
        # 获取创建时间
        local created=$(docker inspect --format='{{.Created}}' "$container_name" 2>/dev/null | cut -d'T' -f1 || echo "N/A")
        
        # 获取端口映射
        local ports=$(docker inspect --format='{{range $p, $conf := .NetworkSettings.Ports}}{{(index $conf 0).HostPort}}->{{$p}} {{end}}' "$container_name" 2>/dev/null || echo "N/A")
        
        echo "$status|$created|$ports"
    else
        echo "nonexistent|N/A|N/A"
    fi
}

# 检查镜像是否存在
check_image_exists() {
    docker image inspect "$1" > /dev/null 2>&1
}

# 获取服务名称
get_service_name() {
    local image_name=$1
    echo "${image_name}" | sed 's/[^a-zA-Z0-9_-]//g'
}

# Docker Compose 命令兼容性处理
docker_compose_cmd() {
    # 优先使用 docker compose (V2)
    if command -v docker > /dev/null && docker compose version > /dev/null 2>&1; then
        docker compose "$@"
    # 回退到 docker-compose (V1)
    elif command -v docker-compose > /dev/null; then
        docker-compose "$@"
    else
        log_error "docker compose or docker-compose command not found"
        exit 1
    fi
}

# 检查容器状态
check_container_status() {
    local container_name="$1-container"
    if docker ps -a --format "table {{.Names}}\t{{.Status}}" | grep -q "$container_name"; then
        local status=$(docker ps -a --format "table {{.Names}}\t{{.Status}}" | grep "$container_name" | awk '{print $2}')
        if [[ "$status" == Up* ]]; then
            echo "running"
        else
            echo "stopped"
        fi
    else
        echo "nonexistent"
    fi
}

# 构建命令
build_command() {
    mkdir -p $CONFIG_DIR
    # 解析构建参数
    local cuda_version=$DEFAULT_CUDA_VERSION
    local ubuntu_version=$DEFAULT_UBUNTU_VERSION
    local with_toolkit=$DEFAULT_WITH_TOOLKIT
    local python_version=$DEFAULT_PYTHON_VERSION
    local image_name=$DEFAULT_IMAGE_NAME
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            -c|--cuda-version)
                cuda_version="$2"
                shift 2
                ;;
            -u|--ubuntu-version)
                ubuntu_version="$2"
                shift 2
                ;;
            -t|--with-toolkit)
                with_toolkit="true"
                shift
                ;;
            -p|--python-version)
                python_version="$2"
                shift 2
                ;;
            -i|--image-name)
                image_name="$2"
                shift 2
                ;;
            *)
                log_error "Unknown option: $1"
                usage
                exit 1
                ;;
        esac
    done
    
    # 根据是否包含 toolkit 设置变体
    if [ "$with_toolkit" = "true" ]; then
        local cuda_variant="devel"
    else
        local cuda_variant="base"
    fi
    
    # 设置全局变量用于保存配置
    CUDA_VERSION=$cuda_version
    UBUNTU_VERSION=$ubuntu_version
    WITH_TOOLKIT=$with_toolkit
    PYTHON_VERSION=$python_version
    IMAGE_NAME=$image_name
    CUDA_VARIANT=$cuda_variant
    
    echo "Build configuration:"
    echo "  CUDA version: $CUDA_VERSION"
    echo "  Ubuntu version: $UBUNTU_VERSION"
    echo "  CUDA variant: $CUDA_VARIANT"
    echo "  Python version: $PYTHON_VERSION"
    echo "  Image name: $IMAGE_NAME"
    echo "  Project path: $PROJECT_ROOT"
    
    # 检查依赖
    check_dependencies
    
    # 生成配置文件
    generate_dockerfile "$CUDA_VERSION" "$UBUNTU_VERSION" "$CUDA_VARIANT" "$PYTHON_VERSION"
    generate_docker_compose "$IMAGE_NAME"
    save_config
    
    # 构建镜像
    build_image
    
    # 清理旧的全局配置文件
    cleanup_old_global_configs
    
    # 保存到全局配置
    save_to_global
}

# 运行命令
run_command() {
    mkdir -p $CONFIG_DIR

    if ! load_config; then
        log_error "Configuration file not found, please run build command first: cudo build"
        exit 1
    fi
    
    if ! check_image_exists "$IMAGE_NAME"; then
        log_error "Image '$IMAGE_NAME' does not exist, please run build command first: cudo build"
        exit 1
    fi
    
    # 保存到全局配置（确保现有环境也被记录）
    save_to_global
    
    local command=${1:-exec}
    local service_name=$(get_service_name "$IMAGE_NAME")
    
    case $command in
        "status")
            local status=$(check_container_status "$IMAGE_NAME")
            case $status in
                "running")
                    log_success "Container is running"
                    ;;
                "stopped")
                    log_warning "Container is stopped"
                    ;;
                "nonexistent")
                    log_info "Container does not exist"
                    ;;
            esac
            ;;
        "start")
            log_info "Starting container..."
            cd "$CONFIG_DIR"
            docker_compose_cmd up -d
            ;;
        "stop")
            log_info "Stopping container..."
            cd "$CONFIG_DIR"
            docker_compose_cmd down
            ;;
        "restart")
            log_info "Restarting container..."
            cd "$CONFIG_DIR"
            docker_compose_cmd restart
            ;;
        "reset")
            log_warning "This will reset the container (delete and recreate)"
            log_warning "Project: $PROJECT_ROOT"
            log_warning "Image: $IMAGE_NAME"
            echo
            read -p "Confirm reset? Enter 'y' to continue: " confirm
            if [ "$confirm" != "y" ]; then
                log_info "Operation cancelled"
                exit 0
            fi
            
            log_info "Resetting container (delete and recreate)..."
            cd "$CONFIG_DIR"
            docker_compose_cmd down
            docker_compose_cmd up -d
            ;;
        "logs")
            cd "$CONFIG_DIR"
            docker_compose_cmd logs -f
            ;;
        "exec"|"bash")
            local status=$(check_container_status "$IMAGE_NAME")
            case $status in
                "running")
                    log_info "Entering container..."
                    docker exec -it "${IMAGE_NAME}-container" bash
                    ;;
                "stopped")
                    log_info "Starting container and entering..."
                    cd "$CONFIG_DIR"
                    docker_compose_cmd up -d
                    sleep 2
                    docker exec -it "${IMAGE_NAME}-container" bash
                    ;;
                "nonexistent")
                    log_info "Creating and starting container..."
                    cd "$CONFIG_DIR"
                    docker_compose_cmd up -d
                    sleep 2
                    docker exec -it "${IMAGE_NAME}-container" bash
                    ;;
            esac
            ;;
        "remove")
            log_warning "This will delete the container, image, and all configuration files"
            log_warning "Project: $PROJECT_ROOT"
            log_warning "Image: $IMAGE_NAME"
            echo
            read -p "Confirm deletion? Enter 'y' to continue: " confirm
            if [ "$confirm" != "y" ]; then
                log_info "Operation cancelled"
                exit 0
            fi
            
            log_info "Cleaning up container and image..."
            cd "$CONFIG_DIR"
            docker_compose_cmd down 2>/dev/null || true
            docker rmi "$IMAGE_NAME" 2>/dev/null || true
            rm -rf "$CONFIG_DIR" 2>/dev/null || true
            remove_from_global
            log_success "All containers, images, and configuration files cleaned up"
            ;;
        *)
            log_error "Unknown run command: $command"
            usage
            exit 1
            ;;
    esac
}

# 配置命令
config_command() {
    if load_config; then
        echo "Current configuration:"
        echo "  CUDA version: $CUDA_VERSION"
        echo "  Ubuntu version: $UBUNTU_VERSION"
        echo "  CUDA variant: $CUDA_VARIANT"
        echo "  Python version: $PYTHON_VERSION"
        echo "  Image name: $IMAGE_NAME"
    else
        log_info "No configuration found, using defaults:"
        echo "  CUDA version: $DEFAULT_CUDA_VERSION"
        echo "  Ubuntu version: $DEFAULT_UBUNTU_VERSION"
        echo "  CUDA variant: runtime"
        echo "  Python version: $DEFAULT_PYTHON_VERSION"
        echo "  Image name: $DEFAULT_IMAGE_NAME"
    fi
}

# 列出所有 CUDA 环境
list_command() {
    local show_details=${1:-false}
    local show_gpu=${2:-false}
    
    # 使用简化版本的 Python 脚本来显示表格
    local python_script="$PYTHON_SCRIPT_DIR/cuda-env-list-simple.py"
    
    if [ ! -f "$python_script" ]; then
        log_error "Python list script not found: $python_script"
        log_info "Please ensure the Python script is installed in the correct location"
        log_info "Expected location: $PYTHON_SCRIPT_DIR/cuda-env-list-simple.py"
        return 1
    fi
    
    local args=""
    if [ "$show_details" = "true" ]; then
        args="$args --details"
    fi
    if [ "$show_gpu" = "true" ]; then
        args="$args --gpu"
    fi
    
    python3 "$python_script" $args
}

# 显示用法
usage() {
    cat << EOF
Cudo - CUDA Development Environment Manager

Usage: cudo <command> [options]

Commands:
  build [options]    Build CUDA environment image
  run [subcommand]   Run and manage containers
  config             Show current configuration
  list [options]     List all CUDA environments
  help               Show this help message

Build options:
  -c, --cuda-version     CUDA version (default: $DEFAULT_CUDA_VERSION)
  -u, --ubuntu-version   Ubuntu version (default: $DEFAULT_UBUNTU_VERSION)
  -t, --with-toolkit     Include CUDA Toolkit (flag, no value needed) (default: $DEFAULT_WITH_TOOLKIT)
  -p, --python-version   Python version (default: $DEFAULT_PYTHON_VERSION)
  -i, --image-name       Image name (default: based on project name)

Run subcommands:
  (no subcommand)    Start and enter container
  status             Check container status
  start              Start container
  stop               Stop container
  restart            Restart container (preserve state)
  reset              Reset container (delete and recreate)
  logs               View container logs
  exec               Enter container
  remove             Delete container, image and configuration files

List options:
  -d, --details      Show detailed resource information (CPU, memory usage, etc.)
  -g, --gpu          Show GPU memory usage information

Examples:
  cudo build -c 11.8.0 -p 3.8
  cudo run
  cudo run status
  cudo run logs
  cudo config
  cudo list
  cudo list --details
  cudo run remove
EOF
}

# 主函数
main() {
    local command=$1
    shift
    
    # 每次执行命令时都更新全局状态
    update_global_status
    
    case $command in
        "build")
            build_command "$@"
            ;;
        "run")
            run_command "$@"
            ;;
        "logs")
            run_command logs
            ;;
        "remove")
            run_command remove
            ;;
        "restart")
            run_command restart
            ;;
        "reset")
            run_command reset
            ;;
        "status")
            run_command status
            ;;
        "exec")
            run_command exec
            ;;
        "config")
            config_command
            ;;
        "list")
            local show_details=false
            local show_gpu=false
            while [[ $# -gt 0 ]]; do
                case $1 in
                    -d|--details)
                        show_details=true
                        shift
                        ;;
                    -g|--gpu)
                        show_gpu=true
                        shift
                        ;;
                    *)
                        shift
                        ;;
                esac
            done
            list_command "$show_details" "$show_gpu"
            ;;
        "help"|"-h"|"--help"|"")
            usage
            ;;
        *)
            log_error "Unknown command: $command"
            usage
            exit 1
            ;;
    esac
}

# 运行主函数
main "$@"
